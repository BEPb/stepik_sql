

<img src="../art/3.5.5.task.png" alt="solution" >

```sql
WITH get_count_correct (st_n_c, count_correct) 
  AS (
    SELECT step_name, count(*)
    FROM 
        step 
        INNER JOIN step_student USING (step_id)
    WHERE result = "correct"
    GROUP BY step_name
   ),
  get_count_wrong (st_n_w, count_wrong) 
  AS (
    SELECT step_name, count(*)
    FROM 
        step 
        INNER JOIN step_student USING (step_id)
    WHERE result = "wrong"
    GROUP BY step_name
   )  
SELECT st_n_c AS Шаг,
    IF((ROUND(count_correct / (count_correct + count_wrong) * 100)) IS NOT NULL, 
       (ROUND(count_correct / (count_correct + count_wrong) * 100)), 
       100) AS Успешность
FROM  
    get_count_correct 
    LEFT JOIN get_count_wrong ON st_n_c = st_n_w
UNION
SELECT st_n_w AS Шаг,
    IF((ROUND(count_correct / (count_correct + count_wrong) * 100)) IS NOT NULL, 
       (ROUND(count_correct / (count_correct + count_wrong) * 100)), 
       0) AS Успешность
FROM  
    get_count_correct 
    RIGHT JOIN get_count_wrong ON st_n_c = st_n_w
ORDER BY 2, 1 ;

```

значительно более короткая запись:
```sql
WITH tt1 AS (
    SELECT 
       step_name,
       SUM(CASE result WHEN 'correct' THEN 1 ELSE 0 END) c_c,
       SUM(CASE result WHEN 'wrong' THEN 1 ELSE 0 END) c_w
    FROM step INNER JOIN step_student USING (step_id)
    GROUP BY step_name
)
SELECT step_name Шаг,
       IF(c_c = 0, 0, IF(c_w = 0, 100, ROUND((c_c / (c_c + c_w) * 100),0))) Успешность
FROM tt1
ORDER BY 2 ASC,1 ASC;
```



#### На [главную](https://github.com/BEPb/stepik_sql#readme)

---


